<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/node-mongodb-native/2.0/img/favicon.png">

    <title>Connection Failures</title>

    <link href="/node-mongodb-native/2.0/css/bootstrap-theme.css" rel="stylesheet">
    <link href="/node-mongodb-native/2.0/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="/node-mongodb-native/2.0/css/style.css" rel="stylesheet">
    <link href="/node-mongodb-native/2.0/css/style-responsive.css" rel="stylesheet" />
    <link href="/node-mongodb-native/2.0/css/monokai_sublime.css" rel="stylesheet" />

  </head>

  <body>
  
  <section id="container" class="">

      
      <header class="header black-bg">
            <div class="toggle-nav">
                <i class="fa fa-bars"></i>
                <div class="icon-reorder tooltips" data-original-title="Toggle Navigation" data-placement="bottom"></div>
            </div>

            
            <a href="http://learnmongodbthehardway.com/" class="logo"><img src="/node-mongodb-native/2.0/img/logo-mongodb-header.png" style="height:40px;"></a>

            
            <div class="top-nav notification-row">
                
                <div class="hidden-xs nav-github pull-right">
                    <span rel="show-github" data-user="mongodb" data-repo="node-mongodb-native"></span>
                    <a href='http://travis-ci.org/mongodb/node-mongodb-native'><img src='https://secure.travis-ci.org/mongodb/node-mongodb-native.png'/><a>
                </div>
            </div>

            <div class="nav title-row" id="top_menu">
                <h1 class="nav top-menu"> MongoDB 2.0.0 Driver </h1>
            </div>
      </header>
      


<aside>
    <div id="sidebar"  class="nav-collapse ">
        
        <ul class="sidebar-menu">
          
          
              
                <li>
                <a class="" href="http://learnmongodbthehardway.com/">
                    <i class='fa fa-file-text'></i>
                    
                    <span>driver portal</span>
                </a>
              
              </li>
          
              
                <li>
                <a class="" href="http://mongodb.org">
                    <i class='fa fa-file-text'></i>
                    
                    <span>Mongo DB Docs</span>
                </a>
              
              </li>
          
              
                <li>
                <a class="" href="/node-mongodb-native/2.0/node-mongodb-native/1/index.4/">
                    <i class='fa fa-file-text'></i>
                    
                    <span>legacy docs 1.4.X</span>
                </a>
              
              </li>
          
              

            <li class="sub-menu">
            <a href="javascript:;" class="">
                <i class='fa fa-gift'></i>
                
                <span>about driver</span>
                <span class="menu-arrow fa fa-angle-right"></span>
            </a>
                <ul class="sub">
                    
                    <li><a href="/node-mongodb-native/2.0/meta/license/"> License </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/meta/release-notes/"> Release Notes </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/meta/changes-from-1.0/"> Migrating to 2.X </a> </li>
                    
                </ul>
              
              </li>
          
              

            <li class="sub-menu">
            <a href="javascript:;" class="">
                <i class='fa fa-road'></i>
                
                <span>getting started</span>
                <span class="menu-arrow fa fa-angle-right"></span>
            </a>
                <ul class="sub">
                    
                    <li><a href="/node-mongodb-native/2.0/overview/introduction/"> Introduction </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/overview/installing/"> Installing The Driver </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/overview/quickstart/"> QuickStart </a> </li>
                    
                </ul>
              
              </li>
          
              

            <li class="sub-menu">
            <a href="javascript:;" class="">
                <i class='fa fa-file-text'></i>
                
                <span>api</span>
                <span class="menu-arrow fa fa-angle-right"></span>
            </a>
                <ul class="sub">
                    
                    <li><a href="/node-mongodb-native/2.0/api-docs/"> API Documentation </a> </li>
                    
                </ul>
              
              </li>
          
              

            <li class="sub-menu">
            <a href="javascript:;" class="">
                <i class='fa fa-group'></i>
                
                <span>community</span>
                <span class="menu-arrow fa fa-angle-right"></span>
            </a>
                <ul class="sub">
                    
                    <li><a href="/node-mongodb-native/2.0/community/mailing-list/"> Mailing List </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/community/contributing/"> Contributing </a> </li>
                    
                </ul>
              
              </li>
          
              

            <li class="sub-menu active">
            <a href="javascript:;" class="">
                <i class='fa fa-book'></i>
                
                <span>tutorials</span>
                <span class="menu-arrow fa fa-angle-down"></span>
            </a>
                <ul class="sub open">
                    
                    <li><a href="/node-mongodb-native/2.0/tutorials/connecting/"> Connecting To MongoDB </a> </li>
                    
                    <li class="active"><a href="/node-mongodb-native/2.0/tutorials/connection_failures/"> Connection Failures </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/tutorials/urls/"> Connection URI </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/tutorials/crud_operations/"> CRUD Operations </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/tutorials/aggregation/"> Aggregation </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/tutorials/streams/"> Streams </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/tutorials/gridfs/"> GridFS </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/tutorials/logging/"> Logging </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/tutorials/objectid/"> ObjectId </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/tutorials/tracing/"> Tracing </a> </li>
                    
                </ul>
              
              </li>
          
              

            <li class="sub-menu">
            <a href="javascript:;" class="">
                <i class='fa fa-book'></i>
                
                <span>articles</span>
                <span class="menu-arrow fa fa-angle-right"></span>
            </a>
                <ul class="sub">
                    
                    <li><a href="/node-mongodb-native/2.0/articles/node_knockout_article_1/"> Node Knockout, Basics </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/articles/node_knockout_article_2/"> Node Knockout, GridFS </a> </li>
                    
                    <li><a href="/node-mongodb-native/2.0/articles/node_knockout_article_3/"> Node Knockout, GEO </a> </li>
                    
                </ul>
              
              </li>
          
            <li> <a href="https://jira.mongodb.org/browse/NODE" target="blank"><i class='fa fa-life-ring'></i>Issues & Help</a> </li>
            
              

      
      <section id="main-content">
          <section class="wrapper">

              
                  
                      
                      
                          
                          
                          
                      
                      
                  
              

              <div class="row">
                  <div class="col-md-1">
                      
                      
                      <a class="navigation prev" href="../../tutorials/connecting">
                      <i class="fa fa-angle-left"></i>
                      </a>
                      
                      
                  </div>
                <div class="col-md-10">
                    <section class="panel">
                          
                              
                          
                    <div class="panel-body">



<h1 id="connection-failures-and-retries:878abfdd112f1319523c821f1974dcfd">Connection Failures and Retries</h1>

<p>This comes up a lot because there is some confusion about how the driver works when it comes to Socket timeouts and retries. This Tutorial attempts to clarify the driver&rsquo;s behavior and explains why, for some legacy reasons as well as for some design reasons, the driver works the way it does.</p>

<p>Let&rsquo;s start off by looking at the Simple case of a single server connection and how it behaves when tweaking the options that control the driver behavior on server disconnects.</p>

<p>First let&rsquo;s start with a simple script performing inserts and find, and running against a server on <code>localhost:27017</code>.</p>

<pre><code class="language-javascript">var MongoClient = require('mongodb').MongoClient
  , f = require('util').format;

MongoClient.connect('mongodb://localhost:27017/test', function(err, db) {
  var col = db.collection('t');

  setInterval(function() {
    col.insert({a:1}, function(err, r) {
      console.log(&quot;insert&quot;)
      console.log(err)

      col.findOne({}, function(err, doc) {
        console.log(&quot;findOne&quot;)
        console.log(err)
      });
    })
  }, 1000)
});
</code></pre>

<p>Start the script and notice how it prints out <code>insert</code> and <code>findOne</code> every second. Now shut down the <code>mongod</code> process and notice how you stop seeing the console printouts. What is happening is that the server is buffering operations until the <code>mongod</code> returns because the two parameters controlling this behavior are set to the default value. These parameters are:</p>

<table>
<thead>
<tr>
<th><code>Parameter</code></th>
<th align="left"><code>Value</code></th>
<th align="left"><code>Description</code></th>
</tr>
</thead>

<tbody>
<tr>
<td>autoReconnect</td>
<td align="left">true</td>
<td align="left">Driver will attempt to auto reconnect</td>
</tr>

<tr>
<td>bufferMaxEntries</td>
<td align="left">-1</td>
<td align="left">Max Number of operations buffered while waiting for server reconnect. Driver will error out all operations if the number of buffered operations goes over the limit set</td>
</tr>
</tbody>
</table>

<p>By default the driver attempts to reconnect and buffers all operations until it can. This is due to backward compatibility.</p>

<p>Now let&rsquo;s try to disable the <code>bufferMaxEntries</code> by setting it to <code>0</code> and see what happens.</p>

<pre><code class="language-javascript">var MongoClient = require('mongodb').MongoClient
  , f = require('util').format;

MongoClient.connect('mongodb://localhost:27017/test', {
    db: { bufferMaxEntries: 0 }
  }, function(err, db) {
  var col = db.collection('t');

  setInterval(function() {
    col.insert({a:1}, function(err, r) {
      console.log(&quot;insert&quot;)
      console.log(err)

      col.findOne({}, function(err, doc) {
        console.log(&quot;findOne&quot;)
        console.log(err)
      });
    })
  }, 1000)
});
</code></pre>

<p>Start the script running and then shut down the <code>mongod</code> process. Notice how all operations are now erroring out instead of just being buffered? Now restart the <code>mongod</code> service and you will see the the operations once again correctly being executed.</p>

<p>So what happens if we disable <code>autoReconnect</code> by setting it to <code>false</code>? Let&rsquo;s take a look.</p>

<pre><code class="language-javascript">var MongoClient = require('mongodb').MongoClient
  , f = require('util').format;

MongoClient.connect('mongodb://localhost:27017/test?autoReconnect=false', function(err, db) {
  var col = db.collection('t');

  setInterval(function() {
    col.insert({a:1}, function(err, r) {
      console.log(&quot;insert&quot;)
      console.log(err)

      col.findOne({}, function(err, doc) {
        console.log(&quot;findOne&quot;)
        console.log(err)
      });
    })
  }, 1000)
});
</code></pre>

<p>When you shut down the <code>mongod</code> process, the driver stops processing operations and keeps buffering them due to <code>bufferMaxEntries</code> being <code>-1</code> by default meaning buffer all operations. When you bring the <code>mongod</code> process back up you will notice how it does not change the fact that we are buffering. This is a legacy behavior and less than ideal. So you will want to set <code>bufferMaxEntries</code> to 0 or a low number if you wish to turn off <code>autoReconnect</code>.</p>

<h2 id="the-matrix-of-behavior:878abfdd112f1319523c821f1974dcfd">The Matrix of Behavior</h2>

<p>Let&rsquo;s put all the possible values of <code>autoReconnect</code> and <code>bufferMaxEntries</code> in a table so we can more easily understand the behavior.</p>

<table>
<thead>
<tr>
<th align="left"><code>autoReconnect</code></th>
<th align="left"><code>bufferMaxEntries</code></th>
<th align="left"><code>Description</code></th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">true</td>
<td align="left">0</td>
<td align="left">Auto reconnect but do not buffer operations, error out until server reconnect</td>
</tr>

<tr>
<td align="left">true</td>
<td align="left">-1</td>
<td align="left">Auto reconnect, buffer all operations until memory run out</td>
</tr>

<tr>
<td align="left">true</td>
<td align="left">&gt; 0</td>
<td align="left">Auto reconnect, buffer all operations until the bufferMaxEntries is reached and then error out all buffered operations</td>
</tr>

<tr>
<td align="left">false</td>
<td align="left">0</td>
<td align="left">Auto reconnect is off, do not buffer operations, error out all operations</td>
</tr>

<tr>
<td align="left">false</td>
<td align="left">-1</td>
<td align="left">Auto reconnect is off, buffer all operations until memory run out</td>
</tr>

<tr>
<td align="left">false</td>
<td align="left">&gt; 0</td>
<td align="left">Auto reconnect is off, buffer all operations until the bufferMaxEntries is reached and then error out all buffered operations</td>
</tr>
</tbody>
</table>

<p>So why is this the case? Well, the main reason is a combination of the asynchronous behavior of <code>node.js</code> as well as <code>Replicasets</code>. When you are using a single server the behavior might be a bit mystifying, but it makes sense in the context of the <code>Replicaset</code>.</p>

<p>Say you have a <code>Replicaset</code> where a new primary is elected. If the driver does not buffer the operations, it will have to error out all operations until there is a new primary available in the set. This complicates people&rsquo;s code as every operation could potentially fail and thus the driver a long time ago took the decision to make this transparent to the user by buffering operations until the new <code>primary</code> is available and then replaying them. <code>bufferMaxEntries</code> was added later to allow developers to control this behavior themselves if they wished to be instantly notified about write errors f.ex instead of letting the driver handle it.</p>

<h2 id="the-confusion:878abfdd112f1319523c821f1974dcfd">The Confusion</h2>

<p>A lot of the confusion comes from mistaking <code>socketTimeoutMS</code> with how the async driver works. <code>socketTimeoutMS</code> only applies to sockets if they have successfully connected to the server, but have not been in use and they reach the <code>socketTimeoutMS</code>. In contrast, <code>connectionTimeoutMS</code> applies only to the <em>initial</em> server connection process timeout.  The &lsquo;connectionTimeoutMS&rsquo; is independent of the <code>socketTimeoutMS</code>.</p>

<p>However, some people set <code>socketTimeoutMS</code> expecting it to influence timeouts for operations. But as we have seen above the <code>autoReconnect</code> and <code>bufferMaxEntries</code> are the two settings that control that behavior.</p>

<p>It&rsquo;s worth noting that you should ensure you have a reasonable <code>socketTimeoutMS</code>. A lot of people set it way way too low and find themselves with timeouts happening all the time as operations are infrequent enough to cause constant connection closing and reconnect events.</p>

<p>The rule of thumb I always impart is:</p>

<blockquote>
<p>Set <em>socketTimeoutMS</em> to at least <code>2-3x</code> the longest running operation in your application or the interval between operations, too ensure you don&rsquo;t timeout long running operations or servers where there are big gaps of time between operations.</p>
</blockquote>

<h2 id="what-you-are-probably-looking-for:878abfdd112f1319523c821f1974dcfd">What You are Probably Looking For</h2>

<p>Most people who start changing <code>socketTimeoutMS</code> are actually looking for the <code>maxTimeMS</code> property to limit the time a query runs against the server before it gets aborted. Let&rsquo;s look at how to apply this property on a query.</p>

<pre><code class="language-javascript">var MongoClient = require('mongodb').MongoClient
  , f = require('util').format;

MongoClient.connect('mongodb://localhost:27017/test', function(err, db) {
  var cursor = db.collection('t').find({}).maxTimeMS(1000);
  cursor.toArray(function(err, docs) {
    console.dir(docs)
    db.close();
  });
});
</code></pre>

<p>This executes a query and sets the <code>maxTimeMS</code> property to <code>1000</code> milliseconds. If the query runs for longer than that time it will be aborted by the server.</p>

                      
                      <div id="disqus_thread"></div>
                      <script type="text/javascript">
                           
                          var disqus_shortname = 'nodejsmongodbdriver'; 

                           
                          (function() {
                              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                          })();
                      </script>
                      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                      <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                      
                    </div>
                    </section>
                </div>
                <div class="col-md-1">
                    
                    
                    <a class="navigation next" href="../../tutorials/urls">
                        <i class="fa fa-angle-right"> </i>
                    </a>
                    
                    
                </div>
              </div>
              
          </section>
      </section>
     
  </section>
  
    
    <script src="/node-mongodb-native/2.0/js/jquery-2.1.1.min.js"></script>
    <script src="/node-mongodb-native/2.0/js/jquery.scrollTo.min.js"></script>
    <script src="/node-mongodb-native/2.0/js/bootstrap.min.js"></script>
    
    <script src="/node-mongodb-native/2.0/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/node-mongodb-native/2.0/js/scripts.js"></script>
    <script async defer id="github-bjs" src="/node-mongodb-native/2.0/js/buttons.js"></script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29229787-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>

